<apex:page docType="html-5.0"
sidebar="false" 
showheader="false"
standardStylesheets="false"
Controller="ProjectController"
applyHtmlTag="false"
applyBodyTag="false"
>
<html ng-app="taskyApp">
<head>
  <title> Tasky </title>
  <apex:stylesheet value="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400"/>
  <meta name="viewport" content="width=device-width, initial-scale=1,  minimum-scale=1, maximum-scale=1, user-scalable=no"/>
  <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.1.5/angular.js"> </script>
  <apex:includeScript value="//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"/>
  <apex:includeScript value="{!URLFOR($Resource.ChecklistAssets, 'forceTK/forceTK.js')}"/>
  <apex:includeScript value="{!URLFOR($Resource.RollCallAssets, 'fastclick/fastclick.js')}"/>
</head>
</html>

<body>
    <div ng-controller="ProjectCtrl">
        <h1> Tasky </h1>
        <p> Select a Project </p>
        <div ng-repeat="project in projects" ng-click="getTasks(project.Id)"> 
            <p > {{project.Name}} </p>
            <p> {{project.Description__c}} </p>
        </div>
        <h1> Task </h1>
        <div ng-repeat="task in tasks">
            <input ng-model="task.Name"></input>
            <input ng-model="task.Detail__c"></input>
            <input ng-model="task.Status__c"></input>
            <p> {{task.Deadline__c}} </p>
            <p ng-show="task.Late__c">Late</p>
            <button ng-click="upsertTask(task)"> Upsert </button>
            <button ng-click="updateTaskStatus(task.Id, task.Status__c)"> Update Status </button>
        </div>
        <h1> End </h1>
        <h1> Users </h1>
        <div ng-repeat="user in users" ng-click="addCollaborator(projects[0].Id, user.Id)">
            <p> {{user.Name}} </p>
        </div>
        <h1> Current </h1>
        <div ng-repeat="projUser in projUsers" ng-click="removeCollaborator(projUser.Id)">
            <p> {{projUser.Name}} </p>
        </div>
        <input ng-model="projName"></input>
        <input ng-model="description"></input>
        <button ng-click="createProject(projName, description)"> Create Project </button>
        <input ng-model="currentTask.Name"></input>
        <input ng-model="currentTask.Detail__c"></input>
        <input type="datetime" ng-model="currentTask.Deadline__c"></input>
        <button ng-click="upsertTask(currentTask)"> Create Task </button>

    </div>

</body>


<script>
/** Angular Script */
var checklistApp = angular.module('taskyApp', []);

checklistApp.controller('ProjectCtrl', function($scope) {

    /** An array of Projects. */
    $scope.projects = [];
    /** An array of Tasks. */
    $scope.tasks = [];
    /** The current task we are reviewing. */
    $scope.currentTask = {};
    /** The list of all users in the org, */
    $scope.users = [];
    $scope.projUsers = [];


    /** Takes COLLABORATORS and gets project information from them. */
    var createProjectsFromCollaborators = function(collaborators) {
        for(var i = 0; i < collaborators.length; i++) {
            $scope.projects[i] = collaborators[i].Project__r;
        }
    }
    var getProjectCollaborators = function() {
        Visualforce.remoting.Manager.invokeAction(
            '{!$RemoteAction.ProjectController.getProjectCollaborators}',
            $scope.projects[0].Id,
            function(result, event) {
                if (event.status) {
                    $scope.projUsers = result;
                    $scope.$apply();
                } else if (event.type === 'exception') {
                    console.log('exception');
                } else {
                    console.log('error');
                }
            }
            );
    }

    /** Gets all Collaborators that look up to current user. */
    var getUserCollaborators = function() {
        Visualforce.remoting.Manager.invokeAction(
            '{!$RemoteAction.ProjectController.getUserCollaborators}',
            function(result, event) {
                if (event.status) {
                    createProjectsFromCollaborators(result);
                    $scope.currentProject = $scope.projects[0];
                    getProjectCollaborators();


                    $scope.$apply();
                } else if (event.type === 'exception') {
                    console.log('exception');
                } else {
                    console.log('error');
                }
            }
            );
    }

    /** Gets all the Tasks in project with Id PROJECTID. */
    $scope.getTasks = function(projectId) {
        console.log('start');
        Visualforce.remoting.Manager.invokeAction(
            '{!$RemoteAction.ProjectController.getTasks}',
            projectId,
            function(result, event) {
                if (event.status) {
                    console.log(result);
                    $scope.tasks = result;
                    $scope.$apply();
                } else if (event.type === 'exception') {
                    console.log('exception');
                } else {
                    console.log('error');
                }
            }
            );
    }

    /** Creates a project with NAME and DESCRIPTION. */
    $scope.createProject = function(name, description) {
        Visualforce.remoting.Manager.invokeAction(
            '{!$RemoteAction.ProjectController.createProject}',
            name,
            description,
            function(result, event) {
                if (event.status) {
                    console.log('Create Project')
                    $scope.$apply();
                } else if (event.type === 'exception') {
                    console.log('exception');
                } else {
                    console.log('error');
                }
            }
            );
    }

    /** Updates the STATUS of Task with Id TASKID. */
    $scope.updateTaskStatus = function(taskId, status) {
        Visualforce.remoting.Manager.invokeAction(
            '{!$RemoteAction.ProjectController.updateTaskStatus}',
            taskId,
            status,
            function(result, event) {
                if (event.status) {
                    console.log('Updated task');
                } else if (event.type === 'exception') {
                    console.log('exception');
                } else {
                    console.log('error');
                }
            }
            );
    }

    getUserCollaborators();

    /** Strips task to allow it to be inserted to database. */
    var stripTask = function(task) {
        copy = {};
        copy.Deadline__c = task.Deadline__c;
        copy.Detail__c = task.Detail__c;
        copy.Id = task.Id;
        copy.Name = task.Name;
        copy.Project__c = task.Project__c;
        copy.Status__c = task.Status__c;
        return copy;
    }

    /** Upserts the TASK into the database. */
    $scope.upsertTask = function(task) {
        console.log($scope.currentProject);
        console.log(task);
        task.Project__c = $scope.currentProject.Id;
        Visualforce.remoting.Manager.invokeAction(
            '{!$RemoteAction.ProjectController.upsertTask}',
            stripTask(task),
            function(result, event) {
                if (event.status) {
                    console.log('Create Task')
                } else if (event.type === 'exception') {
                    console.log('exception');
                } else {
                    console.log('error');
                }
            }
            );
    }

    /** Returns all users in the org. */
    $scope.getOrgUsers = function() {
        Visualforce.remoting.Manager.invokeAction(
            '{!$RemoteAction.ProjectController.getOrgUsers}',
            function(result, event) {
                if (event.status) {
                    $scope.users = result;
                    $scope.$apply();
                } else if (event.type === 'exception') {
                    console.log('exception');
                } else {
                    console.log('error');
                    console.log(event.message);
                }
            }
            );
    }

    /** Adds a collaborator that ties the user with Id USERID to a 
    *  Project with Id PROJECTID. */
    $scope.addCollaborator = function(projectId, userId) {
        Visualforce.remoting.Manager.invokeAction(
            '{!$RemoteAction.ProjectController.addCollaborator}',
            projectId,
            userId,
            function(result, event) {
                if (event.status) {
                    console.log('Added user');
                } else if (event,type === 'exception') {
                    console.log('exception');
                } else {
                    console.log('error');
                }
            }
            );
    }

    /** Removes the Collaborator with Id COLLABORATOR ID from a Project. */
    $scope.removeCollaborator = function(collaboratorId) {
        Visualforce.remoting.Manager.invokeAction(
            '{!$RemoteAction.ProjectController.removeCollaborator}',
            collaboratorId,
            function(result, event) {
                if (event.status) {
                    console.log('Removed user');
                } else if (event,type === 'exception') {
                    console.log('exception');
                } else {
                    console.log('error');
                }
            }
            );
    }

    $scope.getOrgUsers();

});

</script>
</apex:page>