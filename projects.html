<apex:page docType="html-5.0"
sidebar="false"
showheader="false"
standardStylesheets="false"
Controller="ProjectController"
applyHtmlTag="false"
applyBodyTag="false"
>
<html ng-app="taskyApp">
<head>
  <title> Tasky </title>
  <apex:stylesheet value="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400"/>
  <meta name="viewport" content="width=device-width, initial-scale=1,  minimum-scale=1, maximum-scale=1, user-scalable=no"/>
  <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.1.5/angular.js"> </script>
  <apex:includeScript value="//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"/>
  <apex:includeScript value="{!URLFOR($Resource.ChecklistAssets, 'forceTK/forceTK.js')}"/>
  <apex:includeScript value="{!URLFOR($Resource.RollCallAssets, 'fastclick/fastclick.js')}"/>
  <apex:stylesheet value="{!URLFOR($Resource.TaskyAssets, 'fonts/proximanova.css')}"/>
  <apex:includeScript value="{!URLFOR($Resource.StreamAssets, 'cometd.js')}"/>
  <apex:includeScript value="{!URLFOR($Resource.StreamAssets, 'json2.js')}"/>
  <apex:includeScript value="{!URLFOR($Resource.StreamAssets, 'jquery.cometd.js')}"/>
  <script type="text/javascript">
  function setSection(to, from) {
    $('#collab').animate({"top":"100%"},100,'linear');
    if (!(to.hasClass("active")))
    {
      from.animate({"left":"-100%"},100,'linear')
      to.animate({"left":"0%"},100,'linear',function()
      {
        from.css("left","100%");
        from.removeClass("active");
        to.addClass("active");
      });
      if (to.is("#one-overall")) {
        $("#newbut").animate({"left":"100%"}, 0);
        $("#newbut").animate({"left":"0"},100,'linear');
        $("#header").animate({"left":"100%"}, 0);
        $("#header").animate({"left":"0"},100,'linear');
      } else {
        $("#newbut").animate({"left":"-100%"},100,'linear');
        $("#header").animate({"left":"-100%"},100,'linear');
      }
      if ($(window).width() < 1000) {
        if (to.is("#one")) {
          $("#pending-tab").addClass("active-tab");
          $("#pending-alt").css("display", "inline");
          $("#pending").css("display", "none");
        }
        if (from.is("#one")) {
          $("#pending-tab").removeClass("active-tab");
          $("#pending").css("display", "inline");
          $("#pending-alt").css("display", "none");
        }
        if (to.is("#two")) {
          $("#doing-tab").addClass("active-tab");
          $("#doing-alt").css("display", "inline");
          $("#doing").css("display", "none");
        }
        if (from.is("#two")) {
          $("#doing-tab").removeClass("active-tab");
          $("#doing").css("display", "inline");
          $("#doing-alt").css("display", "none");
        }
        if (to.is("#three")) {
          $("#complete-tab").addClass("active-tab");
          $("#complete-alt").css("display", "inline");
          $("#complete").css("display", "none");
        }
        if (from.is("#three")) {
          $("#complete-tab").removeClass("active-tab");
          $("#complete").css("display", "inline");
          $("#complete-alt").css("display", "none");
        }
      }
    }
  }
  function switchCollab() {
    $('#switch-collab').animate({"top":"0%"}, { queue: false, duration: 200 }, 'linear');
    $('#switch-collab').animate({"left":"0%"},{ queue: false, duration: 200 }, 'linear');
    $('#switch-collab').animate({"bottom":"0%"},{ queue: false, duration: 200 }, 'linear');
    $('#switch-collab').animate({"right":"0%"},{ queue: false, duration: 200 }, 'linear');
  }
  $(document).ready(function(){
    $('a').on('click', function(event)
    {
      var sectionId = $(this).attr("data-section"),
      $toSlide= $("#container section#"+sectionId),
      $fromSlide= $('.active');
      setSection($toSlide, $fromSlide);
    });
    $('#collab-button').on('click', function(event) {
      $('#collab').animate({"top":"0%"},100,'linear');
    });
    $('#hide-collab').on('click', function(event) {
      $('#collab').animate({"top":"100%"},100,'linear');
    });
    $('#hide-switch-collab').on('click', function(event) {
      $('#switch-collab').animate({"top":"50%"}, { queue: false, duration: 200 }, 'linear');
      $('#switch-collab').animate({"left":"50%"},{ queue: false, duration: 200 }, 'linear');
      $('#switch-collab').animate({"bottom":"50%"},{ queue: false, duration: 200 }, 'linear');
      $('#switch-collab').animate({"right":"50%"},{ queue: false, duration: 200 }, 'linear');
    });
  });
  window.addEventListener('load', function() {
    FastClick.attach(document.body);
  }, false);
  </script>
  <style type="text/css">
  @-webkit-keyframes bugfix {
    from { fill: 0; }
    to { fill: 0; }
  }

  ::-webkit-scrollbar { width: 0 !important }

  body {
    font-family: ProximaNova, sans-serif;
    font-weight: 300;
    font-size: 16px;
    color: #333;
    margin: 0px;
    padding: 0px;
    height: 100%;
    overflow: hidden;
    background: #FFF;
    -webkit-animation: bugfix infinite 1s; 
  }

  *:focus {
    outline: none;
  }

  p {
    padding: 0px;
    margin: 0px;
  }

  #container {
    position: absolute;
    top: 0px;
    left: 0px;
    right: 0px;
    bottom: 0px;
    overflow: hidden;
    background: transparent;
  }

  #container section {
    position: absolute;
    width: 100%;
    height: 100%;
    left: 100%;
    overflow: scroll;
    background: #fff;
    -webkit-overflow-scrolling: touch;
  }

  #container section:nth-child(1) {
    position: absolute;
    left: 0%;
  }

  .overall {
    z-index: 4;
  }

  #header {
    position: absolute;
    z-index: 4;
    top: 0;
    left: 0;
    box-sizing: border-box;
    -moz-box-sizing: border-box;
    height: 100px;
    width: 100%;
    background: #fff;
    border-bottom: 1px solid #ccc;
    padding-top: 30px;
    font-size: 36px;
    font-weight: 700;
    color: #ff9d00;
    text-align: center;
  }

  .small-spacer {
    height: 100px;
    width: 100%;
    padding: 0;
    margin: 0;
  }

  .spacer {
    box-sizing: border-box;
    -moz-box-sizing: border-box;
    height: 135px;
    width: 100%;
  }

  #project-title {
    box-sizing: border-box;
    -moz-box-sizing: border-box;
    position: fixed;
    z-index: 3;
    width: 100%;
    height: 55px;
    top: 0px;
    left: 0px;
    font-weight: 500;
    background: #ff9d00;
    color: #fff;
    font-size: 24px;
    text-align: center;
    padding: 12px;
  }

  .normal-title {
    box-sizing: border-box;
    -moz-box-sizing: border-box;
    float: left;
    width: 100%;
    height: 55px;
    font-weight: 500;
    background: #ff9d00;
    color: #fff;
    font-size: 24px;
    text-align: center;
    padding: 12px;
  }

  #footer {
    box-sizing: border-box;
    -moz-box-sizing: border-box;
    position: fixed;
    z-index: 3;
    width: 100%;
    height: 55px;
    bottom: 0px;
    left: 0px;
    background: #f3f3f3;
    border-top: 1px solid #cccccc;
  }

  .footer-button {
    float: left;
    width: 41px;
    height: 41px;
    margin: 7px;
    margin-right: 10px;
    margin-left: 15px;
  }

  .footer-loader {
    float: left;
    width: 41px;
    height: 41px;
    margin: 7px;
    margin-right: 10px;
    margin-left: 15px;
  }

  input.switch:empty
  {
    margin-left: -9999px;
  }

  input.switch:empty ~ label
  {
    position: relative;
    float: right;
    text-indent: 69px;
    cursor: pointer;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
  }

  input.switch:empty ~ label:before, 
  input.switch:empty ~ label:after
  {
    position: absolute;
    display: block;
    top: 0;
    bottom: 0;
    left: 0;
    content: ' ';
    width: 58px;
    height: 30px;
    margin-top: 12px;
    background-color: #ccc;
    border-radius: 15px;
    -webkit-transition: all 100ms ease-in;
    transition: all 100ms ease-in;
  }

  input.switch:empty ~ label:after
  {
    width: 26px;
    height: 26px;
    top: 2px;
    bottom: 2px;
    margin-left: 2px;
    background-color: #fff;
    border-radius: 13px;
  }

  input.switch:checked ~ label:before
  {
    background-color: #ff9d00;
  }

  input.switch:checked ~ label:after
  {
    margin-left: 30px;
  }

  #view-state-me {
    display: inline;
    float: right;
    color: #999;
    font-size: 18px;
    margin-top: 16px;
    margin-right: 7px;
  }

  #view-state-all {
    display: none;
    float: right;
    color: #ff9d00;
    font-size: 18px;
    margin-top: 16px;
    margin-right: 7px;
  }

  input.switch:empty ~ #view-state-me {
    display: inline;
  } 

  input.switch:checked ~ #view-state-me {
    display: none;
  }

  input.switch:empty ~ #view-state-all {
    display: none;
  }

  input.switch:checked ~ #view-state-all {
    display: inline;
  }

  #navbar {
    position: fixed;
    z-index: 3;
    width: 100%;
    height: 80px;
    top: 55px;
    left: 0px;
    background: #FFF;
    border-bottom: 1px solid #cccccc;
  }

  .navbut {
    box-sizing: border-box;
    -moz-box-sizing: border-box;
    float: left;
    width: 33%;
    height: 80px;
    color: #999999;
    text-align: center;
    text-decoration: none;
    box-shadow: -1px 0px 0px #cccccc;
    background:  #FFF;
  }

  .middle {
    width: 34%;
  }

  #doing-alt, #complete-alt, #pending-alt {
    display: none;
  }

  #pending, #doing, #complete {
    margin-top: 9px;
    width: 40px;
    height: 40px;
  }

  #pending-alt, #doing-alt, #complete-alt {
    margin-top: 9px;
    width: 40px;
    height: 40px;
  }

  #pending-tag, #doing-tag, #complete-tag {
    margin-top: -7px;
  }

  .active-tab {
    border-bottom: 7px solid #FF9D00;
    color: #FF9D00;
  }

  .link {
    box-sizing: border-box;
    -moz-box-sizing: border-box;
    position: relative;
    display: block;
    overflow: hidden;
    color: #4d4d4d;
    text-decoration: none;
    text-align: left;
    font-size: 18px;
    padding: 20px;
    height: 80px;
    box-shadow: -1px -1px #cccccc;
    border-bottom: 1px solid #cccccc;
    background: #FFF;
    width: 100%;
  }

  .link-title {
    padding-top: 2px;
  }

  .link-blurb {
    color: #999999;
    margin-top: -2px;
    font-size: 14px;
  }

  .link-button {
    float: right;
    opacity: 0.5;
    height: 40px;
    width: 40px;
    margin-top: -37px;
  }

  .link-button:hover {
    cursor: pointer;
  }

   .add-collab-button, .remove-collab-button, .assignee-button {
    float: right;
    height: 20px;
    width: 20px;
    padding: 10px;
    border-radius: 20px;
    margin-top: -37px;
    background: #ff9d00;
  }

  .add-collab-button {
    -webkit-transform: rotate(45deg);
    background: #999;
  }

  .not-assignee {
    background: #999;
  }

  .add-collab-button:hover, .remove-collab-button:hover, .assignee-button:hover {
    cursor: pointer;
  }

  .image {
    float: left;
    width: 46px;
    height: 46px;
    margin-left: -3px;
    margin-right: 16px;
    margin-top: -2px;
  }

  #new {
    margin-top: 15px;
    width: 30px;
    height: 30px;
  }

  #new-loader {
    margin-top: 15px;
    width: 30px;
    height: 30px;
  }

  #newtag {
    margin-top: -2px;
  }

  #newbut {
    position: fixed;
    z-index: 4;
    color: #fff;
    text-align: center;
    text-decoration: none;
    width: 100%;
    height: 80px;
    bottom: 0;
    left: 0;
    background: #FF9D00;
  }

  .back {
    position: absolute;
    top: 0;
    left: 0;
    width: 55px;
    height: 55px;
  }

  .arrow-back {
    float: left;
    margin-top: 20px;
    margin-left: 25px;
    width: 10px; 
    height: 10px;
    -webkit-transform: rotate(-135deg);
    border-top: 3px solid #fff;
    border-right: 3px solid #fff;
  }

  .arrow-right {
    float: right;
    margin-top: -25px;
    width: 10px; 
    height: 10px;
    -webkit-transform: rotate(45deg);
    border-top: 3px solid #cccccc;
    border-right: 3px solid #cccccc;
  }

  .x {
    position: absolute;
    top: 0px;
    right: 0px;
    width: 20px;
    height: 20px;
    padding: 17px;
  }

  .x:hover {
    cursor: pointer;
  }

  #collab {
    position: fixed;
    z-index: 4;
    width: 100%;
    height: 100%;
    top: 100%;
    overflow: scroll;
    background: #fff;
    -webkit-overflow-scrolling: touch;
  }

  #switch-collab {
    position: fixed;
    z-index: 4;
    top: 50%;
    bottom: 50%;
    left: 50%;
    right: 50%;
    overflow: scroll;
    background: #fff;
    -webkit-overflow-scrolling: touch;
  }

  #add-collab-input {
    font-family: ProximaNova, sans-serif;
    font-weight: 300;
    font-size: 18px;
    color: #4d4d4d;
    width: 92%;
    margin-top: 6px;
    padding: 4px;
    padding-left: 10px;
    outline: none;
    border: 1px solid #999999;
    max-width: 800px;
    background: transparent;
    border-radius: 5px;
    -webkit-appearance: none;
  }

  .late {
    color: red;
  }

  .back {
    position: absolute;
    top: 0;
    left: 0;
    width: 55px;
    height: 55px;
  }

  .arrow-back {
    float: left;
    margin-top: 20px;
    margin-left: 25px;
    width: 10px; 
    height: 10px;
    -webkit-transform: rotate(-135deg);
    border-top: 3px solid #fff;
    border-right: 3px solid #fff;
  }

  .shorten {
    width: 61%;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .transparent {
    opacity: 0.5;
  }

  /*
  .animate-leave {
    position: relative;
    display: block;
  } 

  .animate-enter, .animater-enter.animate-enter-active {
    animation: none;
    -webkit-animation: none;
  }
 
  .animate-leave.animate-leave-active {
    animation: leave 0.25s;
    -webkit-animation: leave 0.25s;
    animation-fill-mode: both;
  }

  @keyframes leave
  {
    0% {right: 0%; height: 80px;}
    50% {right: -100%; height: 80px;}
    99% {right: -100%; height: 0px;}
    100% {right: -100%; height: 0px; display: none;}
  }

  @-webkit-keyframes leave
  {
    0% {right: 0%; height: 80px;}
    50% {right: -100%; height: 80px;}
    99% {right: -100%; height: 0px;}
    100% {right: -100%; height: 0px; display: none;}
  } */

  html { height: 100%; margin: 0; padding: 0;}

  body { height: 100%; margin: 0; padding: 0 }

  @media (min-width: 1000px) {
    #pending, #doing, #complete {
      display: none;
      margin-top: 12px;
      width: 40px;
      height: 40px;
    }

    #pending-alt, #doing-alt, #complete-alt {
      display: inline;
      margin-top: 12px;
      width: 40px;
      height: 40px;
    }

    #pending-tag, #doing-tag, #complete-tag {
      color: #ff9d00;
    }

    #one {
      box-sizing: border-box;
      position: absolute;
      top: 0% !important;
      left: 0% !important;
      width: 33% !important;
      border-right: 1px solid #ccc;
    }
    #two {
      box-sizing: border-box;
      position: absolute;
      top: 0% !important;
      left: 33% !important;
      width: 34% !important;
      border-right: 1px solid #ccc;
    }
    #three {
      position: absolute;
      top: 0% !important;
      left: 67% !important;
      width: 33% !important;
    }
    .navbut:hover {
      cursor: default;
    }
    .link:hover, #newbut:hover, .footer-button:hover {
      cursor: pointer;
    }
  }
  </style>
</head>
<body ng-app="taskyApp">
  <div id="main-page" ng-controller="ProjectCtrl">
    <div id="navbar">
      <!-- Currently no icons -->
      <a class="navbut" id="pending-tab" data-section="one" href="#">
        <p> <img id="pending" src="{!URLFOR($Resource.TaskyAssets, 'images/pending.svg')}"></img> </p>
        <p> <img id="pending-alt" src="{!URLFOR($Resource.TaskyAssets, 'images/pending-alt.svg')}"></img> </p>
        <p id="pending-tag"> Pending </p>
      </a>
      <a class="navbut middle" id="doing-tab" data-section="two" href="#">
        <p> <img id="doing" src="{!URLFOR($Resource.TaskyAssets, 'images/doing.svg')}"></img> </p>
        <p> <img id="doing-alt" src="{!URLFOR($Resource.TaskyAssets, 'images/doing-alt.svg')}"></img> </p>
        <p id="doing-tag"> Doing </p>
      </a>
      <a class="navbut" id="complete-tab" data-section="three" href="#">
        <p> <img id="complete" src="{!URLFOR($Resource.TaskyAssets, 'images/completed.svg')}"></img> </p>
        <p> <img id="complete-alt" src="{!URLFOR($Resource.TaskyAssets, 'images/completed-alt.svg')}"></img> </p>
        <p id="complete-tag"> Complete </p>
      </a>
    </div>
    <div id="project-title"> {{currentProject.Name}} 
      <a class="back" data-section="one-overall" href="#">
        <div class="arrow-back"></div>
      </a>
    </div>
    <div id="footer">
      <img class="footer-button" src="{!URLFOR($Resource.TaskyAssets, 'images/home.svg')}" ng-click="sOneNav(currentProject.Id)"></img>
      <img id="footer-preload" class="footer-button" src="{!URLFOR($Resource.TaskyAssets, 'images/new.svg')}" ng-click="sOneCreate('Tasky_Task__c');" ng-show="creatable"></img>
      <img class="footer-loader" src="{!URLFOR($Resource.TaskyAssets, 'images/gray-loader.gif')}" ng-show="!creatable"></img>
      <img id="collab-button" class="footer-button" src="{!URLFOR($Resource.TaskyAssets, 'images/collabs.svg')}"></img>
      <div>
        <input type="checkbox" id="switch1" name="switch1" class="switch" ng-model="all"/>
        <label for="switch1"> &nbsp; </label>
        <span id="view-state-me"> Me </span>
        <span id="view-state-all"> All </span>
      </div>
    </div>
    <div id="container">
      <section id="one-overall" class="active overall">
        <div class="small-spacer"></div>
        <a class="link" data-section="one" ng-click="getTasks(project.Id); projectTransition(project);" ng-repeat="project in projects">
          <img class="image" src="{{idToUrlMap[project.CreatedById]}}"></img>
          <p class="link-title shorten"> {{project.Name}} </p>
          <p class="link-blurb shorten"> {{project.Description__c}} &nbsp; </p>
          <div class="arrow-right"></div>
        </a>
        <div class="spacer"></div>
      </section>
      <div id="header">Tasky</div>
      <div id="newbut" ng-click="sOneCreate('Tasky_Project__c');">
        <p><img id="new" src="{!URLFOR($Resource.ChecklistAssets, 'new.svg')}" ng-show="creatable"></img>
          <img id="new-loader" src="{!URLFOR($Resource.TaskyAssets, 'images/orange-loader.gif')}" ng-show="!creatable"></img>
        </p>
        <p id="newtag"> New </p>
      </div>
      <section id="one">
        <div class="spacer"></div>
        <div class="link" ng-repeat="task in tasks | listType:'Pending' | allFilter:this">
          <div ng-click="updateAssigneeNav(task)">
            <img class="image" ng-show="task.Assignee__r" src="{{idToUrlMap[task.Assignee__r.User__c]}}"></img>
            <img class="image" ng-show="!task.Assignee__r" src="{!URLFOR($Resource.TaskyAssets, 'images/question.svg')}"></img>
          </div>
          <div ng-click="sOneNav(task.Id)">
            <p class="link-title shorten"> {{task.Name}} </p>
            <p class="link-blurb shorten" ng-show="!task.Late__c"> {{task.Deadline__c | date:'MM/dd/yyyy @ h:mma'}} &nbsp; </p>
            <p class="link-blurb late shorten" ng-show="task.Late__c"> {{task.Deadline__c | date:'MM/dd/yyyy @ h:mma'}} &nbsp; </p>
          </div>
          <img class="link-button" src="{!URLFOR($Resource.TaskyAssets, 'images/doing.svg')}" ng-click="updateTaskStatus(task.Id, 'Doing')"></img>
        </div>
        <div class="spacer"></div>
      </section>
      <section id="two">
        <div class="spacer"></div>
        <div class="link" ng-repeat="task in tasks | listType:'Doing' | allFilter:this">
          <div ng-click="updateAssigneeNav(task)">
            <img class="image" ng-show="task.Assignee__r" src="{{idToUrlMap[task.Assignee__r.User__c]}}"></img>
            <img class="image" ng-show="!task.Assignee__r" src="{!URLFOR($Resource.TaskyAssets, 'images/question.svg')}"></img>
          </div>
          <div ng-click="sOneNav(task.Id)">
            <p class="link-title shorten"> {{task.Name}} </p>
            <p class="link-blurb shorten" ng-show="!task.Late__c"> {{task.Deadline__c | date:'MM/dd/yyyy @ h:mma'}} &nbsp;  </p>
            <p class="link-blurb late shorten" ng-show="task.Late__c"> {{task.Deadline__c | date:'MM/dd/yyyy @ h:mma'}} &nbsp; </p>
          </div>
          <img class="link-button" src="{!URLFOR($Resource.TaskyAssets, 'images/completed.svg')}" ng-click="updateTaskStatus(task.Id, 'Done')"></img>
        </div>
        <div class="spacer"></div>
      </section>
      <section id="three">
        <div class="spacer"></div>
        <div class="link" ng-repeat="task in tasks | listType:'Done' | allFilter:this">
          <div ng-click="updateAssigneeNav(task)">
            <img class="image" ng-show="task.Assignee__r" src="{{idToUrlMap[task.Assignee__r.User__c]}}"></img>
            <img class="image" ng-show="!task.Assignee__r" src="{!URLFOR($Resource.TaskyAssets, 'images/question.svg')}"></img>
          </div>
          <div ng-click="sOneNav(task.Id)">
            <p class="link-title shorten"> {{task.Name}} </p>
            <p class="link-blurb late shorten"> {{task.Completed_Date__c | date:'MM/dd/yyyy @ h:mma'}} &nbsp; </p>
          </div>
          <img class="link-button" src="{!URLFOR($Resource.TaskyAssets, 'images/pending.svg')}" ng-click="updateTaskStatus(task.Id, 'Pending')"></img>
        </div>
        <div class="spacer"></div>
      </section>
      <div id="collab">
        <img class="x" id="hide-collab" src="{!URLFOR($Resource.ChecklistAssets, 'x.svg')}"></img>
        <div class="normal-title"> Collaborators </div>
        <div class="link">
          <input type="text" id="add-collab-input" ng-model="searchText" placeholder="Search for a person..."/>
        </div>
        <div class="link" ng-repeat="collaborator in projectCollaborators | filter:searchText">
          <img class="image" src="{{idToUrlMap[collaborator.User__c]}}"></img>
          <p class="link-title shorten"> {{collaborator.Name}} </p>
          <p class="link-blurb shorten"> &nbsp; </p>
          <img class="remove-collab-button" src="{!URLFOR($Resource.ChecklistAssets, 'x.svg')}" ng-click="removeCollaborator(collaborator.Id)"></img>
        </div>
        <div class="link transparent" ng-repeat="user in users | filter:searchText">
          <img class="image" src="{{idToUrlMap[user.Id]}}"></img>
          <p class="link-title shorten"> {{user.Name}} </p>
          <p class="link-blurb shorten">  &nbsp;  </p>
          <img class="add-collab-button" src="{!URLFOR($Resource.ChecklistAssets, 'x.svg')}" ng-click="addCollaborator(currentProject.Id, user.Id)"></img>
        </div>
      </div>
      <div id="switch-collab">
        <img class="x" id="hide-switch-collab" src="{!URLFOR($Resource.ChecklistAssets, 'x.svg')}"></img>
        <div class="normal-title"> Change Assignee </div>
        <div class="link">
          <input type="text" id="add-collab-input" ng-model="searchText" placeholder="Search for a person..."/>
        </div>
        <div ng-repeat="collaborator in projectCollaborators | filter:searchText">
        <div class="link" ng-show="currentTask.Assignee__c == collaborator.Id">
          <img class="image" src="{{idToUrlMap[collaborator.User__c]}}"></img>
          <p class="link-title shorten"> {{collaborator.Name}} </p>
          <p class="link-blurb shorten"> {{collaborator.User__r.Email}} </p>
          <img class="assignee-button" src="{!URLFOR($Resource.TaskyAssets, 'images/check.svg')}" ng-click="assignTask(currentTask, collaborator)"></img>
        </div>
        <div class="link transparent" ng-show="currentTask.Assignee__c != collaborator.Id">
          <img class="image" src="{{idToUrlMap[collaborator.User__c]}}"></img>
          <p class="link-title shorten"> {{collaborator.Name}} </p>
          <p class="link-blurb shorten"> {{collaborator.User__r.Email}} </p>
          <img class="assignee-button not-assignee" src="{!URLFOR($Resource.TaskyAssets, 'images/check.svg')}" ng-click="assignTask(currentTask, collaborator)"></img>
        </div>
      </div>
      </div>
    </div>
  </div>
</body>
</html>
<script>
/** Angular Script */
var checklistApp = angular.module('taskyApp', []);

checklistApp.controller('ProjectCtrl', function($scope) {

  /** An array of Projects. */
  $scope.projects = [];
  /** An array of Tasks. */
  $scope.tasks = [];
  /** The current task we are reviewing. */
  $scope.currentTask = {};
  /** The list of all users in the org, */
  $scope.users = [];
  /** List of all collaborators in a project. */
  $scope.projectCollaborators = [];
  /** Map of Ids to Url. */
  $scope.idToUrlMap= {};
  /** Set of User Ids. */
  $scope.userIds = {};
  /** The current project. */
  $scope.currentProject;
  /** Whether or not it is me. */
  $scope.all = false;
  /** Maps projectId to Collaborators. */
  $scope.projectCollaboratorMap = {};
  /** Whether or not to use stream updates. */
  $scope.streamUpdate = true;
  /** True if we can go to the create view. */
  $scope.creatable = true;


  /** Naviages to the view page of the object with ID. */
  $scope.sOneNav = function(Id) {
    if((typeof sforce != 'undefined') && (sforce != null)) {
      sforce.one.navigateToSObject(Id);
    } else {
      window.location.assign("/" + Id);
    }
  }

  $scope.sOneCreate = function(type) {
    if ($scope.creatable) {
      $scope.creatable = false;
      if((typeof sforce != 'undefined') && (sforce != null)) {
        sforce.one.createRecord(type);
      } else if (type == 'Tasky_Project__c'){
        window.location.assign('{!URLFOR($Action.Tasky_Project__c.New)}');
      } else {
        window.location.assign('{!URLFOR($Action.Tasky_Task__c.New)}');
      }
      setTimeout(function(){$scope.creatable = true; $scope.$apply();}, 2000);
    }
  }

  var getUserImages = function() {
    var keys = Object.keys($scope.userIds);
    Visualforce.remoting.Manager.invokeAction(
      '{!$RemoteAction.ProjectController.getPhotoes}',
      keys,
      function(result, event) {
        if (event.status) {
          for(var i = 0; i < result.length; i++) {
            $scope.idToUrlMap[keys[i]] = result[i];
          }
          console.log($scope.idToUrlMap);
          $scope.$apply();
        } else if (event.type === 'exception') {
          console.log('exception');
        } else {
          console.log('error');
        }
      }
      )
  }

  /** Gets all the Collaborators in a project. */
  var getProjectCollaborators = function(projectId) {
    console.log('ran');
    Visualforce.remoting.Manager.invokeAction(
      '{!$RemoteAction.ProjectController.getProjectCollaborators}',
      projectId,
      function(result, event) {
        if (event.status) {
          /** List of all collaborators in a project. */
          console.log(result);
          $scope.projectCollaborators = result;
          for (var i = 0; i < result.length; i++) {
            $scope.userIds[result[i].User__c] = true;
          }
          getUserImages();
        } else if (event.type === 'exception') {
          console.log('exception');
        } else {
          console.log('error');
        }
      }
      );
  }

  /** Gets all currentProjects. */
  var getProjects = function() {
    Visualforce.remoting.Manager.invokeAction(
      '{!$RemoteAction.ProjectController.getProjects}',
      function(result, event) {
        if (event.status) {
          $scope.projects = result;
          for (var i = 0; i < result.length; i++) {
            $scope.userIds[result[i].CreatedById] = true;
          }
          getUserImages();
        } else if (event.type === 'exception') {
          console.log('exception');
        } else {
          console.log('error');
        }
      }
      );
  }

  /** Transition to a PROJECT. */
  $scope.projectTransition = function(project) {
    console.log('it is');
    $scope.currentProject = project;
    setSection($('#one'), $('#one-overall'));
    getProjectCollaborators(project.Id);
  }

  /** Gets all the Tasks in project with Id PROJECTID. */
  $scope.getTasks = function(projectId, transition) {
    Visualforce.remoting.Manager.invokeAction(
      '{!$RemoteAction.ProjectController.getTasks}',
      projectId,
      function(result, event) {
        if (event.status) {
          $scope.tasks = result;
          for (var i = 0; i < result.length; i++) {
            var task = result[i];
            if (task.Assignee__c) {
              $scope.userIds[task.Assignee__r.User__c] = true;
            }
          }
          console.log('here');
          $scope.getOrgUsers(projectId);
          $scope.$apply();
        } else if (event.type === 'exception') {
          console.log('exception');
        } else {
          console.log('error');
        }
      }
      );
  }

  /** Select a collaborator for a TASK. */
  $scope.updateAssigneeNav = function(task) {
    $scope.currentTask = task;
    switchCollab();
  }

/** Strips task to allow it to be inserted to database. */
  var stripTask = function(task) {
        copy = {};
        copy.Deadline__c = task.Deadline__c;
        copy.Detail__c = task.Detail__c;
        copy.Id = task.Id;
        copy.Name = task.Name;
        copy.Project__c = task.Project__c;
        copy.Status__c = task.Status__c;
        return copy;
    }

  /** Assigns TASK to COLLABORATOR. */
  $scope.assignTask = function(task, collaborator) {
    Visualforce.remoting.Manager.invokeAction(
      '{!$RemoteAction.ProjectController.assignTask}',
      stripTask(task),
      collaborator.Id,
      function(result, event) {
        if (event.status) {
          $scope.currentTask.Assignee__c = result.Assignee__c;
          $scope.$apply();
        } else if (event.type == 'exception') {
          console.log('exception');
        } else {
          console.log('error');
        }
      }
      );
  }

  /** Updates the STATUS of Task with Id TASKID. */
  $scope.updateTaskStatus = function(taskId, status) {
    $scope.streamUpdate = false;
    Visualforce.remoting.Manager.invokeAction(
      '{!$RemoteAction.ProjectController.updateTaskStatus}',
      taskId,
      status,
      $scope.currentProject.Id,
      function(result, event) {
        if (event.status) {
          $scope.tasks = result;
          $scope.$apply();
          console.log('Updated task');
        } else if (event.type === 'exception') {
          console.log('exception');
        } else {
          console.log('error');
        }
      }
      );
  }

    getProjects();

  /** Returns all users in the org that are in project with Id PROJID. */
  $scope.getOrgUsers = function(projId) {
    Visualforce.remoting.Manager.invokeAction(
      '{!$RemoteAction.ProjectController.getOrgUsers}',
      projId,
      function(result, event) {
        if (event.status) {
          $scope.users = result;
         for(var i = 0; i < result.length; i++) {
            $scope.userIds[result[i].Id] = true;
          }
          console.log(result);
          getUserImages();
        } else if (event.type === 'exception') {
          console.log('exception');
        } else {
          console.log('error');
          console.log(event.message);
        }
      }
      );
  }

    /** Adds a collaborator that ties the user with Id USERID to a
    *  Project with Id PROJECTID. */
    $scope.addCollaborator = function(projectId, userId) {
      Visualforce.remoting.Manager.invokeAction(
        '{!$RemoteAction.ProjectController.addCollaborator}',
        projectId,
        userId,
        function(result, event) {
          if (event.status) {
            $scope.users = result[0];
            $scope.projectCollaborators = result[1];
            $scope.$apply();
          } else if (event.type === 'exception') {
            console.log('exception');
          } else {
            console.log('error');
          }
        }
        );
    }

    /** Removes the Collaborator with Id COLLABORATOR ID from a Project. */
    $scope.removeCollaborator = function(collaboratorId) {
      Visualforce.remoting.Manager.invokeAction(
        '{!$RemoteAction.ProjectController.removeCollaborator}',
        collaboratorId,
        function(result, event) {
          if (event.status) {
            $scope.users = result[0];
            $scope.projectCollaborators = result[1];
            $scope.$apply();
          } else if (event.type === 'exception') {
            console.log('exception');
          } else {
            console.log('error');
          }
        }
        );
    }

    $scope.convertTime = function(time) {
      var date = new Date(time);
      return date.toString();
    }

    $.cometd.init({
     url: window.location.protocol+'//'+window.location.hostname+'/cometd/24.0/',
     requestHeaders: { Authorization: 'OAuth {!$Api.Session_ID}'}
   });

           // Subscribe to a topic. JSON-encoded update will be returned
           // in the callback

           $.cometd.subscribe('/topic/ProjectUpdates', function(message) {
            getProjects();
          });

           $.cometd.subscribe('/topic/TaskUpdates', function(message) {
            if ($scope.streamUpdate) {
              $scope.getTasks($scope.currentProject.Id);
            } else {
              $scope.streamUpdate = true;
            }
          });

         });

checklistApp.filter('listType', function() {
  return function(input, type) {
    finalList = [];
    for (var i = 0; i < input.length; i++) {
      if (input[i].Status__c == type) {
        finalList.push(input[i]);
      }
    }
    return finalList;

  }
});
checklistApp.filter('allFilter', function() {
  return function(input, scope, user) {
    finalList = [];
    if (scope.all) {
      return input
    }
    for (var i = 0; i < input.length; i++) {
      if (input[i].Assignee__r && (input[i].Assignee__r.User__c == '{!$User.Id}')) {
        finalList.push(input[i]);
      }
    }
    return finalList;
  }
});
</script>

</apex:page>
